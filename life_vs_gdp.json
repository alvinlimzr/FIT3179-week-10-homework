{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 960,
  "height": 520,
  "background": "white",
  "title": {
    "text": "Life expectancy vs GDP per capita",
    "anchor": "start",
    "subtitle": "Select year with the slider; GDP is log-scaled"
  },

  "params": [
    { "name": "Year", "value": 2020, "bind": { "input": "range", "min": 1960, "max": 2024, "step": 1 } }
  ],

  "data": { "url": "data/Life_expectancy.csv", "format": { "type": "csv" } },

  "transform": [
    {
      "fold": [
        "1960","1961","1962","1963","1964","1965","1966","1967","1968","1969",
        "1970","1971","1972","1973","1974","1975","1976","1977","1978","1979",
        "1980","1981","1982","1983","1984","1985","1986","1987","1988","1989",
        "1990","1991","1992","1993","1994","1995","1996","1997","1998","1999",
        "2000","2001","2002","2003","2004","2005","2006","2007","2008","2009",
        "2010","2011","2012","2013","2014","2015","2016","2017","2018","2019",
        "2020","2021","2022","2023","2024"
      ],
      "as": ["YearStr", "life"]
    },
    { "calculate": "toNumber(datum.life)", "as": "life" },
    { "filter": "toNumber(datum.YearStr) == Year" },

    {
      "lookup": "Country Code",
      "from": {
        "data": { "url": "data/gdp_pc_cleaned.csv", "format": { "type": "csv" } },
        "key": "Country Code",
        "fields": [
          "1960","1961","1962","1963","1964","1965","1966","1967","1968","1969",
          "1970","1971","1972","1973","1974","1975","1976","1977","1978","1979",
          "1980","1981","1982","1983","1984","1985","1986","1987","1988","1989",
          "1990","1991","1992","1993","1994","1995","1996","1997","1998","1999",
          "2000","2001","2002","2003","2004","2005","2006","2007","2008","2009",
          "2010","2011","2012","2013","2014","2015","2016","2017","2018","2019",
          "2020","2021","2022","2023","2024",
          "Country Name"
        ]
      },
      "as": [
        "g1960","g1961","g1962","g1963","g1964","g1965","g1966","g1967","g1968","g1969",
        "g1970","g1971","g1972","g1973","g1974","g1975","g1976","g1977","g1978","g1979",
        "g1980","g1981","g1982","g1983","g1984","g1985","g1986","g1987","g1988","g1989",
        "g1990","g1991","g1992","g1993","g1994","g1995","g1996","g1997","g1998","g1999",
        "g2000","g2001","g2002","g2003","g2004","g2005","g2006","g2007","g2008","g2009",
        "g2010","g2011","g2012","g2013","g2014","g2015","g2016","g2017","g2018","g2019",
        "g2020","g2021","g2022","g2023","g2024",
        "GDP Country"
      ]
    },

    { "calculate": "toNumber(datum['g' + datum.YearStr])", "as": "gdp" },

    { "filter": "isValid(datum.life) && isFinite(datum.life) && isValid(datum.gdp) && datum.gdp > 0" },
    { "calculate": "toNumber(datum.YearStr)", "as": "yearSel" }
  ],

  "layer": [
    {
      "mark": { "type": "point", "filled": true, "opacity": 0.75, "size": 58 },
      "encoding": {
        "x": {
          "field": "gdp",
          "type": "quantitative",
          "title": "GDP per capita (current US$)",
          "scale": { "type": "log", "nice": true, "clamp": true }
        },
        "y": { "field": "life", "type": "quantitative", "title": "Life expectancy at birth (years)" },
        "tooltip": [
          { "field": "Country Name", "title": "Country" },
          { "field": "Country Code", "title": "ISO3" },
          { "field": "yearSel", "title": "Year" },
          { "field": "gdp", "title": "GDP per cap.", "format": ",.0f" },
          { "field": "life", "title": "Life exp. (yrs)", "format": ".1f" }
        ]
      }
    },
    {
      "transform": [{ "filter": "indexof(['CHN','IND','USA','SGP'], datum['Country Code']) >= 0" }],
      "mark": { "type": "text", "fontWeight": "bold", "dx": 6, "dy": -6 },
      "encoding": {
        "x": { "field": "gdp", "type": "quantitative", "scale": { "type": "log" } },
        "y": { "field": "life", "type": "quantitative" },
        "text": { "field": "Country Code" }
      }
    }
  ]
}
