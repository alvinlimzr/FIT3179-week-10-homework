{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "width": 960,
    "height": 520,
    "background": "white",
    "config": { "view": { "stroke": null } },
    "projection": { "type": "equalEarth" },
    "title": { "text": "World GDP per capita (USD), 2024", "anchor": "start" },
  
    "layer": [
      { "data": { "sphere": {} }, "mark": { "type": "geoshape", "fill": "#e8f4fb" }},
  
      { "data": { "graticule": { "step": [30, 30] } },
        "mark": { "type": "geoshape", "stroke": "#c8d3df", "strokeWidth": 0.6, "opacity": 0.8 } },
  
      {
        "data": { "url": "data/ne_countries.json", "format": { "type": "geojson" } },
        "transform": [
          { "calculate": "datum.properties.ADM0_A3 ?? datum.properties.ISO_A3 ?? datum.properties.ISO_A3_EH", "as": "iso3" },
          {
            "lookup": "iso3",
            "from": {
              "data": { "url": "data/gdp_pc_cleaned.csv" },
              "key": "Country Code",
              "fields": ["Country Name", "gdp_pc_2024", "2024", "GDP_per_capita", "value"]
            }
          },
          {
            "calculate": "isValid(datum.gdp_pc_2024) ? datum.gdp_pc_2024 : (isValid(datum['2024']) ? datum['2024'] : (isValid(datum.GDP_per_capita) ? datum.GDP_per_capita : datum.value))",
            "as": "gdp_pc"
          }
        ],
        "mark": { "type": "geoshape", "stroke": "white", "strokeWidth": 0.3 },
        "encoding": {
          "color": {
            "field": "gdp_pc", "type": "quantitative",
            "title": "GDP per capita (USD, 2024)",
            "scale": { "scheme": "ylgnbu", "type": "log", "clamp": true }
          },
          "tooltip": [
            { "field": "Country Name", "title": "Country" },
            { "field": "iso3", "title": "ISO3" },
            { "field": "gdp_pc", "title": "GDP per capita", "format": ",.0f" }
          ]
        }
      },
  
      {
        "data": { "url": "data/ne_countries.json", "format": { "type": "geojson" } },
        "transform": [
          { "calculate": "datum.properties.ADM0_A3 ?? datum.properties.ISO_A3 ?? datum.properties.ISO_A3_EH", "as": "iso3" },
          {
            "lookup": "iso3",
            "from": {
              "data": { "url": "data/gdp_pc_cleaned.csv" },
              "key": "Country Code",
              "fields": ["gdp_pc_2024", "2024", "GDP_per_capita", "value"]
            }
          },
          { "calculate": "isValid(datum.gdp_pc_2024) ? datum.gdp_pc_2024 : (isValid(datum['2024']) ? datum['2024'] : (isValid(datum.GDP_per_capita) ? datum.GDP_per_capita : datum.value))", "as": "gdp_pc" },
          { "filter": "datum.gdp_pc == null" }
        ],
        "mark": { "type": "geoshape", "fill": "#efefef", "stroke": "white", "strokeWidth": 0.3 }
      }
    ]
  }
  